<?xml version="1.0" encoding="UTF-8"?>

<?include etc\properties.wxi ?>

<?define INSTALLED_PRODUCT_NAME="OSSBuild Build Environment $(var.OSSBUILD_VERSION)" ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:OSSBuild="$(ossbuild.namespaceURI())">
	<Product 
	  Id="*" 
	  Name="$(var.INSTALLED_PRODUCT_NAME)" 
	  Version="$(var.OSSBUILD_VERSION_FULL)" 
	  Language="$(var.CURRENT_LANGUAGE)" 
	  Manufacturer="$(var.MANUFACTURER)" 
	  UpgradeCode="$(var.GUID_OSSBUILD_BUILD_ENV_UPGRADE_CODE)"
	>
		<Package InstallScope="perMachine" InstallPrivileges="elevated" Compressed="yes" Languages="$(var.SUPPORTED_LANGUAGES)" InstallerVersion="$(var.MINIMAL_INSTALLER_VERSION)" />
		<Media Id="1" Cabinet="env_main.cab" EmbedCab="yes" CompressionLevel="high" />
		<Media Id="2" Cabinet="env_msys.cab" EmbedCab="yes" CompressionLevel="high" />
		<MajorUpgrade DowngradeErrorMessage="!(loc.NewerVersionFound)" />

		<Feature Id="ProductFeature" Title="MSys" Level="1">
			<!-- This component group is autogenerated using heat.exe (see the associated batch file in the ./generated/ directory). -->
			<ComponentGroupRef Id="OSSBuildBuildEnvMSys" />
			
			<!-- Adds uninstall shortcuts, etc. -->
			<ComponentGroupRef Id="OSSBuildBuildEnv" />
			
			<!-- Common -->
			<ComponentGroupRef Id="OSSBuildCommon" />
			
			<!-- Python -->
			<ComponentGroupRef Id="PythonCheck" />

			<!-- Note: The following ComponentGroupRef is required to pull in generated authoring from project references. -->
			<ComponentGroupRef Id="Product.Generated" />
		</Feature>

		<ComponentGroup Id="OSSBuildBuildEnv">
			<ComponentRef Id="OSSBuildBuildEnvUninstallShortcut" />
			<ComponentRef Id="OSSBuildBuildEnvMSysX86Shortcut" />
			<ComponentRef Id="OSSBuildBuildEnvMSysX86_64Shortcut" />
		</ComponentGroup>

		<!-- C:\OSSBuild\Environment\ -->
		<DirectoryRef Id="OSSBuildInstallEnvironmentDir">
			<!-- Fill in any files we'll need -->
		</DirectoryRef>

		<DirectoryRef Id="OSSBuildShortcutsToolsDir">
			<Component Id="OSSBuildBuildEnvUninstallShortcut">
				<Shortcut Id="Uninstall" Name="Uninstall Build Environment" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" Directory="OSSBuildShortcutsToolsDir" Description="Uninstalls the OSSBuild v$(var.OSSBUILD_VERSION) build environment." />
				<RegistryValue Root="HKCU" Key="$(var.REGISTRY_OSSBUILD_BUILD_ENV_SHORTCUTS_KEY)" Name="Uninstall" Value="" Type="string" KeyPath="yes" />
				<RemoveFolder Id="OSSBuildShortcutsToolsDir" On="uninstall" />
				<RemoveFolder Id="OSSBuildShortcutsDir" On="uninstall" />
			</Component>
			
			<Component Id="OSSBuildBuildEnvMSysX86Shortcut">
				<Shortcut Id="MSys_x86" Name="OSSBuild (x86) Command Prompt" Target="[!MSYS_X86_BAT]" Directory="OSSBuildShortcutsToolsDir" Description="Creates an MSys command prompt for OSSBuild v$(var.OSSBUILD_VERSION) work on the x86 platform." />
				<RegistryValue Root="HKCU" Key="$(var.REGISTRY_OSSBUILD_BUILD_ENV_SHORTCUTS_KEY)" Name="MSys_x86" Value="" Type="string" KeyPath="yes" />
			</Component>

			<Component Id="OSSBuildBuildEnvMSysX86_64Shortcut">
				<Shortcut Id="MSys_x86_64" Name="OSSBuild (x86_64) Command Prompt" Target="[!MSYS_X86_64_BAT]" Directory="OSSBuildShortcutsToolsDir" Description="Creates an MSys command prompt for OSSBuild v$(var.OSSBUILD_VERSION) work on the x86_64 platform." />
				<RegistryValue Root="HKCU" Key="$(var.REGISTRY_OSSBUILD_BUILD_ENV_SHORTCUTS_KEY)" Name="MSys_x86_64" Value="" Type="string" KeyPath="yes" />
			</Component>
		</DirectoryRef>

		<UIRef Id="SimplifiedUI" />

	</Product>
</Wix>
