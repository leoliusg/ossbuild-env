<?xml version="1.0" encoding="UTF-8"?>

<?include etc\properties.wxi ?>

<?define INSTALLED_PRODUCT_NAME="Basic Git Environment $(var.OSSBUILD_VERSION)" ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:OSSBuild="$(ossbuild.namespaceURI())">
	<Product 
	  Id="*" 
	  Name="$(var.INSTALLED_PRODUCT_NAME)" 
	  Version="$(var.OSSBUILD_VERSION_FULL)" 
	  Language="$(var.CURRENT_LANGUAGE)" 
	  Manufacturer="$(var.MANUFACTURER)" 
	  UpgradeCode="$(var.GUID_OSSBUILD_BASIC_GIT_ENV_UPGRADE_CODE)"
	>
		<Package InstallScope="perMachine" InstallPrivileges="elevated" Compressed="yes" Languages="$(var.SUPPORTED_LANGUAGES)" InstallerVersion="$(var.MINIMAL_INSTALLER_VERSION)" />
		<Media Id="1" Cabinet="env_main.cab" EmbedCab="yes" CompressionLevel="high" />
		<Media Id="2" Cabinet="env_msys.cab" EmbedCab="yes" CompressionLevel="high" />
		<MajorUpgrade DowngradeErrorMessage="!(loc.NewerVersionFound)" />

		<Feature
			Id="Full"
			Title="Basic Git Environment"
			Description="The full environment."
			Level="1"
			Display="expand"
			AllowAdvertise="no"
			ConfigurableDirectory="INSTALLDIR"
		>
			<ComponentRef Id="Empty" />

			<!-- This component group is autogenerated using heat.exe (see the associated batch file in the ./generated/ directory). -->
			<ComponentGroupRef Id="OSSBuildBasicGitEnvMSys" />

			<!-- Adds uninstall shortcuts, etc. -->
			<ComponentGroupRef Id="OSSBuildBasicGitEnv" />

			<!-- Common -->
			<ComponentGroupRef Id="OSSBuildCommon" />

			<!-- WiX -->
			<!-- Disable WiX check for now; it's not a hard dependency anymore. It will be looked for when the environment is run. -->
			<!-- <ComponentGroupRef Id="WiXCheck" /> -->

			<!-- Note: The following ComponentGroupRef is required to pull in generated authoring from project references. -->
			<ComponentGroupRef Id="Product.Generated" />
		</Feature>

		<ComponentGroup Id="OSSBuildBasicGitEnv">
			<ComponentRef Id="OSSBuildBasicGitEnvUninstallShortcut" />
			<ComponentRef Id="OSSBuildBasicGitEnvMSysX86Shortcut" />
		</ComponentGroup>

		<!-- C:\OSSBuild\Git\sys\ -->
		<DirectoryRef Id="OSSBuildInstallSysDir">
			<!-- Fill in any files we'll need -->
		</DirectoryRef>

		<!-- C:\OSSBuild\Git\sys\etc\profile.d\ossbuild\ -->
		<DirectoryRef Id="OSSBuildInstallSysEtcProfileOssbuildDir">
		</DirectoryRef>
		
		<DirectoryRef Id="OSSBuildShortcutsDir">
			<Component Id="OSSBuildBasicGitEnvUninstallShortcut">
				<Shortcut Id="Uninstall" Name="Uninstall Git Environment" Target="[System64Folder]msiexec.exe" Arguments="/x [ProductCode]" Directory="OSSBuildShortcutsDir" Description="Uninstalls the basic git v$(var.OSSBUILD_VERSION) environment." />
				<RegistryValue Root="HKCU" Key="$(var.REGISTRY_OSSBUILD_BASIC_GIT_ENV_SHORTCUTS_KEY)" Name="Uninstall" Value="" Type="string" KeyPath="yes" />
				<RemoveFolder Id="OSSBuildShortcutsDir" On="uninstall" />
			</Component>
			 
			<Component Id="OSSBuildBasicGitEnvMSysX86Shortcut">
				<Shortcut Id="MSys_x86" Name="Git Command Prompt" Target="[!MSYS_X86_BAT]" Directory="OSSBuildShortcutsDir" Description="Creates an MSys command prompt for basic git work." />
				<RegistryValue Root="HKCU" Key="$(var.REGISTRY_OSSBUILD_BASIC_GIT_ENV_SHORTCUTS_KEY)" Name="MSys_x86" Value="" Type="string" KeyPath="yes" />
			</Component>
		</DirectoryRef>

		<UIRef Id="SimplifiedUI" />

	</Product>
</Wix>
